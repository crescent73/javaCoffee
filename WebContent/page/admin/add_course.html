<!DOCTYPE html>
<html lang="en">

<head>
    <title>Add Course</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="../plugins/fontawesome-free/css/all.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="../dist/css/adminlte.min.css">
    <!-- Google Font: Source Sans Pro -->
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
    <!-- 引用vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

    <!-- Select2 -->
    <link rel="stylesheet" href="../plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="../plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">

</head>

<body  style="background-color: #f4f6f9">
<div class="content" id="content">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0 text-dark">课程管理</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="home.html">主页</a></li>
                        <li class="breadcrumb-item active">添加课程</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="card card-default">
            <div class="card-header">
                <h3 class="card-title">添加课程</h3>
            </div>

            <div class="card-body">

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="course_name_input">课程名</label>
                            <input type="text" class="form-control" id="course_name_input" placeholder="输入课程名" v-model="form.courseName">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="course_number_input">课程号</label>
                            <input type="text" class="form-control" id="course_number_input" placeholder="输入课程号" v-model="form.courseNumber">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="course_credit_input">课程学分</label>
                            <input type="text" class="form-control" id="course_credit_input" placeholder="输入课程学分" v-model="form.courseCredit">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="course_school_select">学院</label>
                            <select id="course_school_select" class="form-control select2" data-placeholder="选择课程所属学院">
                                <option value="1">信息与安全工程学院</option>
                                <option value="2">马克思主义学院</option>
                                <option value="3">哲学院</option>
                                <option value="4">经济学院</option>
                                <option value="5">财政税务学院</option>
                                <option value="6">金融学院</option>
                                <option value="7">法学院</option>
                                <option value="8">刑事司法学院</option>
                                <option value="9">外国语学院</option>
                                <option value="10">新闻与文化传播学院</option>
                                <option value="11">工商管理学院</option>
                                <option value="12">文澜学院</option>
                                <option value="13">会计学院</option>
                                <option value="14">统计与数学学院</option>
                                <option value="15">中韩新媒体学院</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="course_semester_select">开课学期</label>
                            <select id="course_semester_select" class="form-control select2" data-placeholder="选择课程开课学期">
                                <option>2019-2020-1</option>
                                <option>2019-2020-2</option>
                                <option>2020-2021-1</option>
                                <option>2020-2021-2</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="course_type_select">课程类型</label>
                            <select id="course_type_select" class="form-control select2" data-placeholder="选择课程类型">
                                <option value="1">必修课</option>
                                <option value="2">选修课</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="course_teacher_select">授课教师</label>
                        <div class="form-group">
                            <select id="course_teacher_select" class="form-control select2" data-placeholder="选择任课教师">

                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="course_teacher_school_filter">教师所在学院</label>
                            <select id="course_teacher_school_filter" class="form-control select2" data-placeholder="教师所在学院">
                                <option value="0">默认</option>
                                <option value="1">信息与安全工程学院</option>
                                <option value="2">马克思主义学院</option>
                                <option value="3">哲学院</option>
                                <option value="4">经济学院</option>
                                <option value="5">财政税务学院</option>
                                <option value="6">金融学院</option>
                                <option value="7">法学院</option>
                                <option value="8">刑事司法学院</option>
                                <option value="9">外国语学院</option>
                                <option value="10">新闻与文化传播学院</option>
                                <option value="11">工商管理学院</option>
                                <option value="12">文澜学院</option>
                                <option value="13">会计学院</option>
                                <option value="14">统计与数学学院</option>
                                <option value="15">中韩新媒体学院</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="course_description_input">课程介绍</label>
                            <textarea type="text" class="form-control" id="course_description_input" placeholder="输入课介绍" v-model="form.courseDescription">
                            </textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="for_course_student">选课学生</label>
                            <select type="text" class="form-control select2" id="for_course_student" data-placeholder="选择学生" multiple>
                            </select>
                        </div>
                    </div>
                </div>

            </div>

            <div class="card-footer">
                <button type="submit" class="btn btn-primary" @click="on_submit()">Submit</button>
            </div>
        </div>

    </div>

</div>


</body>
<!-- jQuery -->
<script src="../plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="../dist/js/adminlte.min.js"></script>
<!-- Select2 -->
<script src="../plugins/select2/js/select2.full.min.js"></script>

<script>
    $(document).ready(function() {
        $("#course_school_select").select2({
            theme: 'bootstrap4'
        });
        $("#course_teacher_school_filter").select2({
            theme: 'bootstrap4'
        });
        $("#course_semester_select").select2({
            theme: 'bootstrap4'
        });
        $("#course_teacher_select").select2({
            theme: 'bootstrap4',
            ajax: {
                delay: 500,
                type: 'post',
                url: '/blackboard/admin/searchTeacherByKey',
                data: function (params) {
                    return {
                        searchKey: params.term
                    };
                },
                processResults: function (data, params) {
                    if(data.code === "208") {
                        var teachers = data.data.data;
                        var list = [];
                        teachers.forEach(function (teacher) {
                            var option = {
                                id: "",
                                text: "",
                            };
                            option.id = teacher.id;
                            option.text = teacher.teacherNumber + " " + teacher.teacherName;
                            list.push(option);
                        });
                        return {
                            results: list
                        }
                    }
                    return {
                        results: []
                    };
                },
                cache: true
            },
            language: {
                noResults: function (params) {
                    return "没有找到，请确认教师姓名或工号。"
                },
                searching: function () {
                    return '搜索中...';
                }
            }
        });
        $("#course_type_select").select2({
            theme: 'bootstrap4'
        });
        $("#for_course_student").select2({
            theme: 'bootstrap4',
            ajax: {
                delay: 500,
                type: 'post',
                url: '/blackboard/system/searchStudentByKey',
                data: function (params) {
                    return {
                        key: params.term
                    };
                },
                processResults: function (data, params) {
                    if(data.code === "208") {
                        var students = data.data.data;
                        var list = [];
                        students.forEach(function (student) {
                            var option = {
                                id: "",
                                text: "",
                            };
                            option.id = student.id;
                            option.text = student.studentNumber + " " + student.studentName;
                            list.push(option);
                        });
                        return {
                            results: list
                        }
                    }
                    return {
                        results: []
                    };
                },
                cache: true
            },
            language: {
                noResults: function (params) {
                    return "没有找到，请确认学生姓名或学号。"
                },
                searching: function () {
                    return '搜索中...';
                }
            }
        });
    });

    var vue = new Vue({
        el: "#content",
        data: {
            form: {
                courseName: "",
                courseNumber: "",
                courseCredit: 0,
                courseSchool: 1,
                courseSemester: "",
                courseType: 1,
                teacherId: 1,
                courseDescription: ""
            },
            studentList: []
        },
        methods: {
            on_submit: function () {
                let self = this;
                self.form.courseSemester = $("#course_semester_select option:selected").text();
                self.form.courseSchool = $("#course_school_select option:selected").val();
                self.form.courseType = $("#course_type_select").val();
                self.form.teacherId = $("#course_teacher_select").val();
                $("#for_course_student option:selected").each(function () {
                    self.studentList.push($(this).val());
                });
                if(this.do_check()) {
                    this.do_post();
                }
            },
            do_post: function () {
                let self = this;
                $.ajax({
                    type:"post",
                    url:"/blackboard/admin/addCourse",
                    data: self.form,
                    success:function(res){
                        self.do_clean(res);
                        console.log(res);
                        console.log(res.code);
                    },
                    error:function(res){
                        console.log(res);
                        alert("出问题了，请稍后重试或者退出重新登录。");
                    }
                })
            },
            do_check: function () {
                if(this.form.courseName === undefined || this.form.courseName.replace("\\s") === "") {
                    alert("课程名不能为空");
                    return false;
                }
                if(this.form.courseNumber === undefined || this.form.courseNumber.replace("\\s") === "") {
                    alert("课程号不能为空");
                    return false;
                }
                if(this.form.courseCredit === undefined || this.form.courseCredit.replace("\\s") === "") {
                    alert("课程学分不能为空");
                    return false;
                }
                if(this.form.courseSemester === undefined || this.form.courseSemester.replace("\\s") === "") {
                    alert("课程学期不能为空");
                    return false;
                }
                return true;
            },
            do_clean: function (data) {
                let self = this;
                if(data.code === "202") {
                    alert("课程添加成功！");
                    if(self.studentList.length === 0) {
                        window.location.href="/blackboard/admin/addCourse";
                    } else {
                        $.ajax({
                            type:"post",
                            url:"/blackboard/system/searchCourse",
                            data: {courseNumber: self.form.courseNumber},
                            success:function(res){
                                console.log(res);
                                console.log(res.code);
                                if(res.code === "208") {
                                    var courseId = res.code.data.data[0].id;
                                    $.ajax({
                                        type:"post",
                                        url:"/blackboard/system/addCourseSchedule",
                                        data: {courseId: courseId, studentList: self.studentList},
                                        success:function(res){
                                            console.log(res);
                                            console.log(res.code);
                                            if(res.code === "202") {
                                                alert("选课学生添加成功！");
                                                window.location.href = "/blackboard/page/admin/add_course.html"
                                            } else {
                                                console.log(res);
                                                alert("出问题了，无法添加选课学生。");
                                                window.location.href = "/blackboard/page/admin/course_detail?course_id=" + courseId;
                                            }
                                        },
                                        error:function(res){
                                            console.log(res);
                                            alert("出问题了，无法添加选课学生。");
                                        }
                                    });
                                } else {
                                    console.log(res);
                                    alert("出问题了，无法添加选课学生。");
                                }
                            },
                            error:function(res){
                                console.log(res);
                                alert("出问题了，无法添加选课学生。");
                            }
                        });
                    }
                } else if(data.code === "203") {
                    alert("课程添加失败！\n" + data.msg);
                } else if(data.code === "301") {
                    alert("课程添加失败！信息不完整！\n" + data.msg);
                }
            }
        }
    })

</script>
</html>